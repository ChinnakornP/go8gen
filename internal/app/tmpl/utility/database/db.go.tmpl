package database

import (
	"database/sql"
	"log"
    "math/rand"
	"time"
)

func Alive(db *sql.DB) {
	log.Println("Connecting to database... ")
	// Ping by itself is un-reliable, the connections are cached. This
	// ensures that the database is still running by executing a harmless
	// dummy query against it.
	_, err := db.Exec("SELECT true")
	if err == nil {
		log.Println("Database connected")
		return
	}

	base, capacity := time.Second, time.Minute
	for backoff := base; err != nil; backoff <<=1 {
		if backoff > capacity {
			backoff = capacity
		}

        /* #nosec */
		jitter := rand.Int63n(int64(backoff * 3))
		sleep := base + time.Duration(jitter)
		log.Println("retrying...")

		time.Sleep(sleep)
	}
}

